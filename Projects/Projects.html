<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projects</title>
  <link rel="stylesheet" href="../H&amp;dM.css" />
</head>
<body>
  <!-- Header will be injected here -->
  <div id="site-header"></div>
  <main>
    <div class="projects-grid" id="projects-container"></div>
  </main>

  <script>
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    fetch('../header.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('site-header').innerHTML = data;
        if (isAdmin) {
          const icon = document.getElementById('edit-icon');
          if (icon) {
            icon.style.display = 'block';
            icon.addEventListener('click', () => {
              document.body.classList.toggle('editing');
              renderProjects();
            });
          }
        }
      });

    let projectEntries = [];
    const container = document.getElementById('projects-container');
    let draggedIndex = null;
    if (isAdmin) {
      const addBtn = document.createElement('button');
      addBtn.id = 'add-project-btn';
      addBtn.textContent = '+';
      addBtn.title = 'Add Project';
      document.body.appendChild(addBtn);

      const modal = document.createElement('div');
      modal.id = 'new-project-modal';
      modal.innerHTML = `
        <div class="modal-content">
          <label>Project identifier <input id="new-project-key" type="text"></label>
          <div>
            <button id="new-project-create">Create</button>
            <button id="new-project-cancel">Cancel</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const keyInput = modal.querySelector('#new-project-key');
      const createBtn = modal.querySelector('#new-project-create');
      const cancelBtn = modal.querySelector('#new-project-cancel');

      addBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
        keyInput.value = '';
        keyInput.focus();
      });

      cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });

      createBtn.addEventListener('click', () => {
        const key = keyInput.value.trim();
        if (!key) return;
        if (projectEntries.some(([k]) => k === key)) {
          alert('Project already exists');
          return;
        }
        projectEntries.push([key, []]);
        renderProjects();
        saveOrder();
        fetch('../create-project.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        }).catch(err => console.error('create-project failed', err));
        modal.style.display = 'none';
      });
    }

    function renderProjects() {
      container.innerHTML = '';
      projectEntries.forEach(([projectKey, images]) => {
        const card = document.createElement('a');
        card.href = `${projectKey}/${projectKey}.html`;
        card.className = 'project-card';

        let content = '';
        if (images.length > 0) {
          const thumbnail = `${projectKey}/Images/${images[0].filename}`;
          content += `<img src="${thumbnail}" alt="${images[0].title}">`;
        } else {
          content += `<div class="no-image">No Image</div>`;
        }
        content += `<div class="project-title">${projectKey.replace(/_/g, ' ')}</div>`;
        card.innerHTML = content;

        if (document.body.classList.contains('editing')) {
          card.setAttribute('draggable', true);
        }
        container.appendChild(card);
      });
    }

    fetch('../all-projects.json')
      .then(response => response.json())
      .then(data => {
        projectEntries = Object.entries(data);
        renderProjects();
      })
      .catch(error => {
        console.error('Error loading all-projects.json:', error);
      });

    document.addEventListener('dragstart', e => {
      if (!e.target.classList.contains('project-card')) return;
      draggedIndex = [...container.children].indexOf(e.target);
      e.dataTransfer.effectAllowed = 'move';
    });

    document.addEventListener('dragover', e => {
      if (document.body.classList.contains('editing') && e.target.classList.contains('project-card')) {
        e.preventDefault();
      }
    });

    document.addEventListener('drop', e => {
      if (!document.body.classList.contains('editing') || !e.target.classList.contains('project-card')) return;
      e.preventDefault();
      const dropIndex = [...container.children].indexOf(e.target);
      const [moved] = projectEntries.splice(draggedIndex, 1);
      projectEntries.splice(dropIndex, 0, moved);
      renderProjects();
      saveOrder();
    });

    function saveOrder() {
      const ordered = {};
      projectEntries.forEach(([key, images]) => {
        ordered[key] = images;
      });
      fetch('../save-projects.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ordered)
      }).catch(err => console.error('Save failed', err));
    }
  </script>
</body>
</html>
